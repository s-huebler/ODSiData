---
title: "Preprocessing"
format: html
editor: visual
---

# Reference

-   Full citation: Bergeron, A., Chevret, S., Granata, A., Chevallier, P., Vincent, L., Huynh, A., Tabrizi, R., Labussiere-Wallet, H., Bernard, M., Chantepie, S., Bay, J.-O., Thiebaut-Bertrand, A., Thepot, S., Contentin, N., Fornecker, L.-M., Maillard, N., Risso, K., Berceanu, A., Blaise, D., Tour, R.P. de L., Chien, J.W., Coiteux, V., Socié, G., Investigators, A.S., 2017. Effect of Azithromycin on Airflow Decline–Free Survival After Allogeneic Hematopoietic Stem Cell Transplant: The ALLOZITHRO Randomized Clinical Trial. JAMA 318, 557–566. <https://doi.org/10.1001/jama.2017.9938>

-   Associated github: <https://gitlab.com/nivall/azimutfeces>

-   Bioproject: PRJNA902819

# Software Versions

Sra toolkit

```         
(sra-env) sophiehuebler@Sophies-MBP RawData % prefetch --version

prefetch : 3.2.1

(sra-env) sophiehuebler@Sophies-MBP RawData % fastq-dump --version

fastq-dump : 3.2.1
```

Qiime2

```         
System versions
Python version: 3.10.14
QIIME 2 release: 2025.4
QIIME 2 version: 2025.4.0
q2cli version: 2025.4.0

Installed plugins
alignment: 2025.4.0
composition: 2025.4.0
cutadapt: 2025.4.0
dada2: 2025.4.0
deblur: 2025.4.0
demux: 2025.4.0
diversity: 2025.4.0
diversity-lib: 2025.4.0
emperor: 2025.4.0
feature-classifier: 2025.4.0
feature-table: 2025.4.0
fragment-insertion: 2025.4.0
longitudinal: 2025.4.0
metadata: 2025.4.0
phylogeny: 2025.4.0
quality-control: 2025.4.0
quality-filter: 2025.4.0
rescript: 2025.4.0
sample-classifier: 2025.4.0
stats: 2025.4.0
taxa: 2025.4.0
types: 2025.4.0
vizard: 0.0.1.dev0
vsearch: 2025.4.0
```

Blast (/Users/sophiehuebler/miniconda3-x86_64/envs/qiime2-env/bin/blastn)

```         
blastn: 2.16.0+
 Package: blast 2.16.0, build Nov 27 2024 10:36:47
```

# Data Access

-   meta_samples.csv downloaded from bioproject

    -   (November 25, 2025)

-   meta_clinical.xlsx downloaded from github (data/metadata/azimut_md_feces.csv)

    -   (November 25, 2025)

-   sequences downloaded from bioproject

    -   (February 4, 2026)

# Reading Data

## Getting accessions

```         
arch -x86_64 zsh
source ~/miniconda3-x86_64/etc/profile.d/conda.sh
cd ~/Documents/ODSi/ODSiData/Allozithro2017/RawData
conda activate sra-env
prefetch --option-file run_accessions.txt
cat run_accessions.txt | while read srr; do fasterq-dump --split-files --progress "$srr"; done
conda deactivate
```

## Creating manifest

```         
../../create_manifest_script.sh
```

## Importing to qiime

```         
conda activate qiime2-env

qiime tools import \
  --type 'SampleData[PairedEndSequencesWithQuality]' \
  --input-path RawData/manifest.tsv \
  --output-path QiimeData/demux.qza \
  --input-format PairedEndFastqManifestPhred33V2
  
qiime demux summarize \
  --i-data QiimeData/demux.qza \
  --o-visualization QiimeData/demux_viz.qzv
  
```

![](images/clipboard-2961914833.png)

![](images/clipboard-131805321.png)

# Cleaning Data

Checked for primers

```         
-------------------------------------------------------
Checking file: SRR22325885_1.fastq
Scanning first 1000 reads for common primers...
-------------------------------------------------------
Primer Name          | Hits       | Region    
-------------------------------------------------------
515F (Parada)        | 0          | 16S V4    
515F (Original)      | 0          | 16S V4    
806R (Apprill)       | 0          | 16S V4    
806R (Original)      | 0          | 16S V4    
341F (Klindworth)    | 0          | 16S V3-V4 
785R (Herlemann)     | 0          | 16S V3-V4 
805R                 | 0          | 16S V3-V4 
27F (Agler)          | 0          | 16S V1    
338R                 | 0          | 16S V2    
534R                 | 0          | 16S V3    
ITS1-F               | 0          | Fungi ITS1
ITS2                 | 0          | Fungi ITS2
ITS3                 | 0          | Fungi ITS3
ITS4                 | 0          | Fungi ITS4
Euk_1391f            | 0          | 18S V9    
EukBr                | 0          | 18S V9    
-------------------------------------------------------
INTERPRETATION:
Hits > 0  : The primer is attached. Trim this length.
Hits = 0  : Primer likely removed by sequencing center.
-------------------------------------------------------
```

```         
-------------------------------------------------------
Scanning ALL files in directory...
Checking first 1000 reads per file.
Filename                       | Primer Found    | Hits      
-------------------------------------------------------
SRR22325978_1.fastq            | 515F_V4         | 2         
-------------------------------------------------------
Done! If the table above is empty, no primers were found.
-------------------------------------------------------
```

```         
qiime dada2 denoise-paired \
  --i-demultiplexed-seqs demux.qza \
  --p-trim-left-f 20 \
  --p-trim-left-r 20 \
  --p-trunc-len-f 240 \
  --p-trunc-len-r 220 \
  --p-min-fold-parent-over-abundance 4 \
  --p-n-threads 8 \
  --o-table table.qza \
  --o-representative-sequences rep-seqs.qza \
  --o-denoising-stats stats.qza
```

## Stats

```         
qiime metadata tabulate \
  --m-input-file stats.qza \
  --o-visualization stats_viz.qzv
```

![](images/clipboard-1521846845.png)

## Table

```         
qiime feature-table summarize \
  --i-table table.qza \
  --o-visualization table_viz.qzv
```

![](images/clipboard-799789989.png)

![](images/clipboard-2301989752.png)

![](images/clipboard-3952271022.png){width="271"}

![](images/clipboard-228824330.png){width="293"}

## Rep Seqs

```         
qiime feature-table tabulate-seqs \
  --i-data rep-seqs.qza \
  --o-visualization rep-seqs_viz.qzv
```

![](images/clipboard-914904057.png)

```         
qiime tools export \
  --input-path rep-seqs.qza \
  --output-path exported-seqs
```

# BLAST Analysis

```{r}
library(RCurl)
library(rBLAST)
library(Biostrings)
library(tidyverse)
```

Only keep the sequences matched to NCBI

```{r}

# 1. DATABASE PATHS -----------------------------------------------------------
conda_blast_path <- "/Users/sophiehuebler/miniconda3-x86_64/envs/qiime2-env/bin"
Sys.setenv(PATH = paste(conda_blast_path, Sys.getenv("PATH"), sep = ":"))

db_dir <- "~/blast_databases"
human_db_path <- file.path(db_dir, "GCF_000001405.39_top_level")
s16_db_path   <- file.path(db_dir, "16S_ribosomal_RNA")

# 2. LOAD SEQUENCES --------------------------------------------------------
fasta_input <- "~/Documents/ODSi/ODSiData/Allozithro2017/QiimeData/exported-seqs/dna-sequences.fasta"
seqs <- readDNAStringSet(fasta_input)
cat("Starting with", length(seqs), "total sequences.\n")

# 3. STEP 1: HUMAN DECONTAMINATION -----------------------------------------
cat("\n--- Step 1: Human Decontamination ---\n")
bl_human <- blast(db = human_db_path)

# High confidence human matches
human_args <- paste('-perc_identity 95', '-qcov_hsp_perc 90', '-num_threads 4')

blast_human <- predict(bl_human, seqs, type = 'megablast', BLAST_args = human_args)

human_ids <- unique(blast_human$qseqid)
non_human_seqs <- seqs[!(names(seqs) %in% human_ids)]

cat("Detected", length(human_ids), "human sequences.\n")
cat("Proceeding with", length(non_human_seqs), "microbial candidate sequences.\n")

# 4. STEP 2: 16S RRNA CLASSIFICATION ---------------------------------------
cat("\n--- Step 2: 16S rRNA Classification ---\n")
bl_16s <- blast(db = s16_db_path)

# Microbiome standard: identity > 75%
s16_args <- paste('-perc_identity 75', 
                  '-word_size 15', 
                  '-qcov_hsp_perc 90', 
                  '-max_target_seqs 10', 
                  '-num_threads 4')

blast_16s <- predict(bl_16s, non_human_seqs, type = 'megablast', BLAST_args = s16_args)
bact_ids <- unique(blast_16s$qseqid)
bact_seqs <- seqs[names(seqs) %in% bact_ids]

# 5. FILTER TO BEST HIT ----------------------------------------------------
cat("Filtering results to best hit per sequence...\n")

top_hits <- blast_16s %>%
  group_by(qseqid) %>%
  arrange(desc(pident), evalue) %>%
  slice(1) %>%
  ungroup()

# 7. CALCULATE SUMMARY STATISTICS -----------------------------------------
cat("\n--- Final Summary Statistics ---\n")

total_count      <- length(seqs)
non_human_count  <- length(non_human_seqs)
classified_count <- length(unique(top_hits$qseqid))

# Calculate percentages
pct_human      <- ((total_count - non_human_count) / total_count) * 100
pct_classified <- (classified_count / non_human_count) * 100
pct_total_loss <- ((total_count - classified_count) / total_count) * 100

# Create a clean summary table
summary_stats <- data.frame(
  Metric = c("Total Raw ASVs", 
             "Human Contaminants Removed", 
             "Microbial Candidates Remaining", 
             "Successfully Classified (16S)",
             "Unclassified"),
  Count = c(total_count, 
            total_count - non_human_count, 
            non_human_count, 
            classified_count, 
            non_human_count - classified_count),
  Percentage = c(100, pct_human, (100 - pct_human), pct_classified, (100 - pct_classified))
)

print(summary_stats)

# Optional: Plotting the "Sankey" or Flow of sequences
# This is great for supplemental figures in your dissertation
cat("\nFinal classification rate among non-human reads:", round(pct_classified, 2), "%\n")

# 6. EXPORT RESULTS --------------------------------------------------------
write_tsv(top_hits, "~/Documents/ODSi/ODSiData/Allozithro2017/FilteredData/16s_blast_results.tsv")
writeXStringSet(bact_seqs, "~/Documents/ODSi/ODSiData/Allozithro2017/FilteredData/cleaned_seqs.fasta")

cat("\nAnalysis Complete. Results saved to '16s_blast_results.tsv'.\n")
```
